export default class Powcaptcha{static tmpHelpers={};static tmpFolder=process?.env?.POWCAPTCHA_TMPFOLDER;static createChallenge(e=50){if(Powcaptcha.init(),!Powcaptcha.tmpHelpers.randomBytes)throw new Error("This device cannot create a challenge as randomBytes function (Crypto module) is missing");var a=[];for(let t=0;t<e;t++)a.push(Powcaptcha.byteArrayToHex(Powcaptcha.tmpHelpers.randomBytes(16)));return a.join("")}static verifySolution(e,a,t=4){if(!e||e.length<32||e.length%32)throw new Error("Invalid challenge string");var r=e.length/32,o=t+2;if(!a||a.length!==r*o)throw new Error("Invalid solution");Powcaptcha.init();var n=require("fs"),i=Powcaptcha.hash(e),i=Powcaptcha.tmpFolder+"/"+i+".pow";if(n.existsSync(i))return!1;var c=Math.pow(10,10-t);for(let t=0;t<r;t++){var p=a.substring(t*o,t*o+o),s=e.substring(32*t,32*t+32);if(!(Powcaptcha.hashInt(s+p)<=c))return!1}if(!Powcaptcha.tmpFolder||!n.existsSync(Powcaptcha.tmpFolder)||!n.lstatSync(Powcaptcha.tmpFolder).isDirectory())throw new Error("Cannot find tmpFolder for Powcaptcha");var l,h=(new Date).getTime()-3e5;for(l of n.readdirSync(Powcaptcha.tmpFolder)){var w=Powcaptcha.tmpFolder+"/"+l;l.endsWith(".pow")&&n.lstatSync(w).mtime.getTime()<h&&n.unlinkSync(w)}return n.writeFileSync(i,""),!0}static async solveChallenge(o,n=4,i=null){if(Powcaptcha.init(),n<1||7<n)throw new Error("Difficulty need to be between 1-7");if(!o||o.length<32||o.length%32)throw new Error("Invalid challenge string");if("undefined"==typeof window||"function"!=typeof Worker)return Powcaptcha.solverWorker(o,n,i);{var c=Powcaptcha.toString()+";\n",p=(c+="Powcaptcha.init();",[]);let a=o.length/32,r=0;for(let e=0;e<o.length;e+=32){var s=c,l=o.substring(e,e+32),l=(s+="(async()=>{self.postMessage(Powcaptcha.solverWorker("+JSON.stringify(l)+", "+JSON.stringify(n)+"))})()",new Blob([s],{type:"text/javascript"}));let t=new Worker(URL.createObjectURL(l));p.push(new Promise(e=>{t.onmessage=t=>{"string"==typeof t.data&&(r++,i&&i(1/a*r),e(t.data))}}))}return(await Promise.all(p)).join("")}}static hash(e){Powcaptcha.init(),e="string"==typeof e?Powcaptcha.tmpHelpers.encode(e):e;let a=2166136261,r=2341284503,o=3386659096,n=2073922445;var i=16777619;for(let t=0;t<e.byteLength;t++){var c=e[t];a=(a^c)>>>0,a=Math.imul(a,i)>>>0,r=(r^c<<1&255)>>>0,r=Math.imul(r,i)>>>0,o=(o^c<<2&255)>>>0,o=Math.imul(o,i)>>>0,n=(n^c<<3&255)>>>0,n=Math.imul(n,i)>>>0}return this.fmix(a)+this.fmix(r)+this.fmix(o)+this.fmix(n)}static hashInt(e){Powcaptcha.init(),e="string"==typeof e?Powcaptcha.tmpHelpers.encode(e):e;let a=2166136261;for(let t=0;t<e.byteLength;t++){var r=e[t];a=(a^r)>>>0,a=Math.imul(a,16777619)>>>0}return this.fmix(a,!1)}static solverWorker(a,r=4,o=null){var n=a.length/32,i=Math.pow(10,10-r),c=Math.pow(10,r+2);let p="";for(let e=0;e<n;e++){let t=Math.pow(10,r+1);for(var s=a.substring(32*e,32*e+32);t<=c;){if(Powcaptcha.hashInt(s+t)<=i){"function"==typeof o&&o(1/n*(e+1)),p+=t;break}t++}}return p}static fmix(t,e=!0){var a=65535&(t=((t>>>=0)^t>>>16)>>>0),a=(t=51819*a+(51819*(t>>>16&65535)+34283*a<<16>>>0)>>>0&4294967295,65535&(t^=t>>>13));return t=((t=44597*a+(44597*(t>>>16&65535)+49842*a<<16>>>0)>>>0&4294967295)^t>>>16)>>>0,e?t.toString(16).padStart(8,"0"):t>>>0}static init(){if(void 0===Powcaptcha.tmpHelpers.encode){let e=new TextEncoder;if(Powcaptcha.tmpHelpers.encode=t=>e.encode(t),"undefined"!=typeof window||"undefined"!=typeof self){let e=(self||window).crypto;void 0!==e&&(Powcaptcha.tmpHelpers.randomBytes=t=>e.getRandomValues(new Uint8Array(t)))}if("undefined"==typeof window){let e=require("node:crypto").randomBytes;Powcaptcha.tmpHelpers.randomBytes=t=>Uint8Array.from(e(t))}}}static byteArrayToHex(e){if(void 0===Powcaptcha.tmpHelpers.hexMap){Powcaptcha.tmpHelpers.hexMap=[];for(let t=0;t<=255;t++)Powcaptcha.tmpHelpers.hexMap.push(t.toString(16).padStart(2,"0"))}e instanceof Uint8Array||(e=new Uint8Array(e));let a="";for(let t=0;t<e.byteLength;t++)a+=Powcaptcha.tmpHelpers.hexMap[e[t]];return a}}"undefined"!=typeof module&&module.exports&&(module.exports=Powcaptcha);