export default class Powcaptcha{static verifiedSolutionsFolder=process?.env?.POWCAPTCHA_VERIFIED_SOLUTIONS_FOLDER;static challengeSalt;static encoder;static createChallenge(e=50,t=4){if(!Powcaptcha.challengeSalt)throw new Error("Powcaptcha.challengeSalt required, should be a random value not exposed to solver clients");let r;if("undefined"!=typeof window||"undefined"!=typeof self){let a=(self||window).crypto;void 0!==a&&(r=t=>{var e;let r="";for(e of a.getRandomValues(new Uint8Array(t)))r+=e.toString(16).padStart(2,"0");return r})}"undefined"==typeof window&&(r=t=>{var e=require("node:crypto").randomBytes;return e(t).toString("hex")});let a=t+"";for(let t=0;t<e;t++)a+=r(16);return a+Powcaptcha.hash(a+Powcaptcha.challengeSalt)}static verifySolution(t,e){var r=Powcaptcha.parseChallengeData(t,!0);if(!e||e.length!==r.solutionLengthRequired)throw new Error("Invalid solution");var a=require("fs"),t=Powcaptcha.verifiedSolutionsFolder+"/"+Powcaptcha.hash(t)+".pow";if(a.existsSync(t))return!1;for(let t=0;t<r.numberPuzzles;t++){var o=e.substring(t*r.lengthPerSolution,t*r.lengthPerSolution+r.lengthPerSolution);if(!(Powcaptcha.hashInt(r.puzzlesString.substring(32*t,32*t+32)+o)<=r.threshold))return!1}if(!Powcaptcha.verifiedSolutionsFolder||!a.existsSync(Powcaptcha.verifiedSolutionsFolder)||!a.lstatSync(Powcaptcha.verifiedSolutionsFolder).isDirectory())throw new Error("Cannot write to verifiedSolutionsFolder for Powcaptcha");var n,i=(new Date).getTime()-3e5;for(n of a.readdirSync(Powcaptcha.verifiedSolutionsFolder)){var l=Powcaptcha.verifiedSolutionsFolder+"/"+n;n.endsWith(".pow")&&a.lstatSync(l).mtime.getTime()<i&&a.unlinkSync(l)}return a.writeFileSync(t,""),!0}static async solveChallenge(t,a=null){var o=Powcaptcha.parseChallengeData(t,!1);let n=o.numberPuzzles;if("undefined"!=typeof window&&"function"==typeof Worker){var i=Powcaptcha.toString()+";\n",l=[];let r=0;for(let e=0;e<n;e++){var c=i,s=o.puzzlesString.substring(32*e,32*e+32),s=(c+="(async()=>{self.postMessage(Powcaptcha.solverWorker("+JSON.stringify(s)+", "+JSON.stringify(o.difficulty)+"))})()",new Blob([c],{type:"text/javascript"}));let t=new Worker(URL.createObjectURL(s));l.push(new Promise(e=>{t.onmessage=t=>{"string"==typeof t.data&&(r++,a&&a(1/n*r),e(t.data))}}))}return(await Promise.all(l)).join("")}{let e="";for(let t=0;t<n;t++)e+=Powcaptcha.solverWorker(o.puzzlesString.substring(32*t,32*t+32),o.difficulty),a&&a(1/n*t);return e}}static hash(e){e=Powcaptcha.toUint8Array(e);let r=2166136261,a=2341284503,o=3386659096,n=2073922445;var i=16777619;for(let t=0;t<e.byteLength;t++){var l=e[t];r=(r^l)>>>0,r=Math.imul(r,i)>>>0,a=(a^l<<1&255)>>>0,a=Math.imul(a,i)>>>0,o=(o^l<<2&255)>>>0,o=Math.imul(o,i)>>>0,n=(n^l<<3&255)>>>0,n=Math.imul(n,i)>>>0}return Powcaptcha.fmix(r)+Powcaptcha.fmix(a)+Powcaptcha.fmix(o)+Powcaptcha.fmix(n)}static hashInt(e){e=Powcaptcha.toUint8Array(e);let r=2166136261;for(let t=0;t<e.byteLength;t++){var a=e[t];r=(r^a)>>>0,r=Math.imul(r,16777619)>>>0}return Powcaptcha.fmix(r,!1)}static solverWorker(t,e=4){var r=Math.pow(10,10-e),a=Math.pow(10,e+2);let o=Math.pow(10,e+1);for(;o<=a;){if(Powcaptcha.hashInt(t+o)<=r)return o.toString();o++}return""}static fmix(t,e=!0){var r=65535&(t=((t>>>=0)^t>>>16)>>>0),r=(t=51819*r+(51819*(t>>>16&65535)+34283*r<<16>>>0)>>>0&4294967295,65535&(t^=t>>>13));return t=((t=44597*r+(44597*(t>>>16&65535)+49842*r<<16>>>0)>>>0&4294967295)^t>>>16)>>>0,e?t.toString(16).padStart(8,"0"):t>>>0}static toUint8Array(t){if(!Powcaptcha.encoder){let e=new TextEncoder;Powcaptcha.encoder=t=>"string"==typeof t||"number"==typeof t?e.encode(t+""):t}return Powcaptcha.encoder(t)}static parseChallengeData(t,e){var r="string"==typeof t?t.length:0;if(r<33||(r-1)%32)throw new Error("Invalid challenge data");if(e&&!Powcaptcha.challengeSalt)throw new Error("Powcaptcha.challengeSalt required, should be a random value not exposed to solver clients");var a=parseInt(t.substring(0,1));if(a<1||7<a)throw new Error("Invalid difficulty, need to be between 1 and 7");r=t.substring(1,r-32);if(e&&Powcaptcha.hash(t.substring(0,t.length-32)+Powcaptcha.challengeSalt)!==t.substring(t.length-32))throw new Error("Invalid challenge hash");e=r.length/32,t=a+2;return{difficulty:a,puzzlesString:r,numberPuzzles:e,lengthPerSolution:t,solutionLengthRequired:e*t,threshold:Math.pow(10,10-a)}}}"undefined"!=typeof module&&module.exports&&(module.exports=Powcaptcha);